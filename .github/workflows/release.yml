name: Build Release

on:
  release:
    types: [created]
  workflow_dispatch:  # Allows manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Add Go bin to PATH
        run: echo "$HOME/go/bin" >> $GITHUB_PATH
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Install fyne-cross
        run: go install github.com/fyne-io/fyne-cross@latest
      
      - name: Build Linux and Windows only
        run: |
          # Modify your script to skip macOS or use fyne-cross directly
          fyne-cross linux --arch=amd64,arm64 --app-version=1.0.0 --app-id=net.semaja2.trmnl
          fyne-cross windows --arch=amd64,arm64 --app-version=1.0.0 --app-id=net.semaja2.trmnl
      
      - name: Rename artifacts to include architecture
        run: |
          # Process each platform directory
          for dir in fyne-cross/dist/*/; do
            if [ -d "$dir" ]; then
              platform=$(basename "$dir")
              echo "Processing $platform..."
              
              # Find all archives and executables in this directory
              find "$dir" -maxdepth 1 -type f \( -name "*.tar.xz" -o -name "*.zip" -o -name "*.exe" \) | while read file; do
                filename=$(basename "$file")
                extension="${filename##*.}"
                basename="${filename%.*}"
                
                # Create new filename with platform/arch
                new_filename="${basename}-${platform}.${extension}"
                
                # Copy to a staging directory with new name
                mkdir -p fyne-cross/release-artifacts
                cp "$file" "fyne-cross/release-artifacts/${new_filename}"
                echo "  Renamed: $filename -> $new_filename"
              done
            fi
          done
          
          echo ""
          echo "Final artifacts for release:"
          ls -lh fyne-cross/release-artifacts/
      
      - name: Upload artifacts to workflow
        uses: actions/upload-artifact@v4
        with:
          name: release-builds-linux-windows
          path: fyne-cross/release-artifacts/
          retention-days: 5
      
      - name: Upload binaries to release
        run: |
          TAG="${{ github.event.release.tag_name }}"
          
          if [ ! -d "fyne-cross/release-artifacts" ] || [ -z "$(ls -A fyne-cross/release-artifacts)" ]; then
            echo "Error: No artifacts found to upload!"
            exit 1
          fi
          
          find fyne-cross/release-artifacts -type f | while read file; do
            echo "Uploading $(basename "$file")..."
            gh release upload "$TAG" "$file" --clobber
          done
          
          echo "âœ“ All artifacts uploaded successfully"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  build-macos:
    runs-on: macos-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Install Fyne dependencies
        run: |
          brew install go
      
      - name: Add Go bin to PATH
        run: echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Install Fyne CLI
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Build AMD64 binary
        run: |
          CGO_ENABLED=1 GOOS=darwin GOARCH=amd64 go build -o trmnl-amd64 .
      
      - name: Build ARM64 binary
        run: |
          CGO_ENABLED=1 GOOS=darwin GOARCH=arm64 go build -o trmnl-arm64 .
      
      - name: Create universal binary
        run: |
          lipo -create -output trmnl trmnl-amd64 trmnl-arm64
          lipo -info trmnl
          chmod +x trmnl
      
      - name: Package as .app bundle
        run: |
          fyne package -os darwin -icon Icon.png -appID net.semaja2.trmnl -appVersion 1.0.0 -name TRMNL -executable trmnl
      
      - name: Remove quarantine attributes
        run: |
          xattr -cr TRMNL.app || true
      
      - name: Package into tar.gz
        run: |
          tar -czf TRMNL-darwin-universal.tar.gz TRMNL.app
          ls -lh TRMNL-darwin-universal.tar.gz
      
      - name: Upload macOS app to release
        run: |
          gh release upload "${{ github.event.release.tag_name }}" \
            TRMNL-darwin-universal.tar.gz \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
