name: Build Release

on:
  release:
    types: [created]
  workflow_dispatch:  # Allows manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Add Go bin to PATH
        run: echo "$HOME/go/bin" >> $GITHUB_PATH
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Install fyne-cross
        run: go install github.com/fyne-io/fyne-cross@latest
      
      - name: Build Linux and Windows only
        run: |
          # Modify your script to skip macOS or use fyne-cross directly
          fyne-cross linux --arch=amd64,arm64 --app-version=1.0.0 --app-id=net.semaja2.trmnl
          fyne-cross windows --arch=amd64,arm64 --app-version=1.0.0 --app-id=net.semaja2.trmnl
      
      - name: Upload binaries to release
        run: |
          find fyne-cross/dist -type f \( -name "*.exe" -o -name "*.tar.xz" -o -name "*.zip" \) 2>/dev/null | while read file; do
            if [ -f "$file" ]; then
              echo "Uploading $file..."
              gh release upload "${{ github.event.release.tag_name }}" "$file" --clobber
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  build-macos:
    runs-on: macos-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Install Fyne dependencies
        run: |
          brew install go
      
      - name: Add Go bin to PATH
        run: echo "$HOME/go/bin" >> $GITHUB_PATH
      
      - name: Install Docker
        run: |
          brew install docker docker-compose
          colima start
          
      - name: Wait for Docker to be ready
        run: |
          echo "Waiting for Docker daemon..."
          for i in {1..30}; do
            if docker info >/dev/null 2>&1; then
              echo "Docker is ready"
              break
            fi
            echo "Waiting for Docker... ($i/30)"
            sleep 2
          done
          docker info
      
      - name: Install fyne CLI
        run: go install fyne.io/fyne/v2/cmd/fyne@latest
      
      - name: Install fyne-cross
        run: go install github.com/fyne-io/fyne-cross@latest
      
      - name: Build macOS binary
        run: |
          # Build natively on macOS
          fyne-cross darwin --arch=amd64,arm64 --app-version=1.0.0 --app-id=net.semaja2.trmnl
      
      - name: Package .app bundles into tar.gz
        run: |
          set -e  # Exit on error
          
          echo "Looking for .app bundles..."
          
          # Function to package an app
          package_app() {
            local app_path="$1"
            local arch="$2"
            local app_name=$(basename "$app_path" .app)
            local output_name="${app_name}-darwin-${arch}.tar.gz"
            
            echo "Packaging: $app_path"
            tar -czf "fyne-cross/dist/${output_name}" -C "$(dirname "$app_path")" "$(basename "$app_path")"
            
            if [ -f "fyne-cross/dist/${output_name}" ]; then
              echo "✓ Created: ${output_name} ($(du -h "fyne-cross/dist/${output_name}" | cut -f1))"
            else
              echo "✗ Failed to create: ${output_name}"
              return 1
            fi
          }
          
          # Package AMD64
          if ls fyne-cross/dist/darwin-amd64/*.app 1> /dev/null 2>&1; then
            for app in fyne-cross/dist/darwin-amd64/*.app; do
              package_app "$app" "amd64"
            done
          else
            echo "⚠ No AMD64 .app found"
          fi
          
          # Package ARM64
          if ls fyne-cross/dist/darwin-arm64/*.app 1> /dev/null 2>&1; then
            for app in fyne-cross/dist/darwin-arm64/*.app; do
              package_app "$app" "arm64"
            done
          else
            echo "⚠ No ARM64 .app found"
          fi
          
          echo ""
          echo "Final archives:"
          ls -lh fyne-cross/dist/*.tar.gz 2>/dev/null || echo "No archives created!"
      
      - name: Upload macOS apps to release
        run: |
          TAG="${{ github.event.release.tag_name }}"
          
          archive_count=0
          find fyne-cross/dist -maxdepth 1 -name "*-darwin-*.tar.gz" -type f | while read file; do
            echo "Uploading $(basename "$file")..."
            gh release upload "$TAG" "$file" --clobber
            archive_count=$((archive_count + 1))
          done
          
          if [ $archive_count -eq 0 ]; then
            echo "✗ No archives found to upload!"
            exit 1
          fi
          
          echo "✓ Uploaded $archive_count macOS archive(s)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
